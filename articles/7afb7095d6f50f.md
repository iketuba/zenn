---
title: "transformersã®tutorialã‚’èª­ã‚“ã§ã¿ãŸ - part1"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python", "æ©Ÿæ¢°å­¦ç¿’", "åˆå¿ƒè€…", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°"]
published: true
---
# ã¯ã˜ã‚ã«
æœ€è¿‘transformersã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‹‰å¼·ã—ã¦ã„ã¦ã€ä»Šã¯tutorialsã‚’èª­ã‚“ã§ã„ã¾ã™ï¼ã›ã£ã‹ããªã®ã§ã€tutorialsã®å†…å®¹ã‚’è¨³ã—ã¦è¨˜äº‹ã«ã—ã‚ˆã†ã¨æ€ã£ã¦ã„ã¾ã™ï¼ä»Šå›ã¯ç¬¬ä¸€å¼¾ã¨ã„ã†ã“ã¨ã§ã€ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«æ›¸ãã¾ã—ãŸï½ ãœã²æœ€å¾Œã¾ã§èª­ã‚“ã§ãã ã•ã„ï¼(google colabã§å®Ÿè£…ã—ãªãŒã‚‰èª­ã‚“ã§é ‚ã‘ã‚‹ã¨è‰¯ã„ã¨æ€ã„ã¾ã™ï¼)
https://huggingface.co/docs/transformers/v4.21.3/en/pipeline_tutorial

# æ¨è«–ç”¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
pipeline()ã‚’ä½¿ãˆã°ã€ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã€ç”»åƒã®ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€éŸ³å£°åˆ†é¡ãªã©æ§˜ã€…ãªã‚¿ã‚¹ã‚¯ã®ãƒ¢ãƒ‡ãƒ«ã‚’Model Hubã‹ã‚‰ç°¡å˜ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ã‚’å‹•ã‹ã™ã‚³ãƒ¼ãƒ‰ã‚’ç†è§£ã—ã¦ã„ãªãã¦ã‚‚ã€pipeline()ã‚’ä½¿ã£ã¦ãƒ¢ãƒ‡ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## Pipelineã®ä½¿ã„æ–¹
å„ã‚¿ã‚¹ã‚¯ã¯é–¢é€£ã™ã‚‹pipeline()ã‚’æŒã¡ã¾ã™ãŒã€ç‰¹å®šã®ã‚¿ã‚¹ã‚¯ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ã™ã¹ã¦å«ã‚€ä¸€èˆ¬çš„ãªpipeline()ã‚’ä½¿ç”¨ã™ã‚‹æ–¹ãŒç°¡å˜ã§ã™ã€‚pipeline()ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’è‡ªå‹•çš„ã«ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

1. ã¾ãšã€pipeline()ã‚’ä½œæˆã—ã€ã‚¿ã‚¹ã‚¯ã‚’æŒ‡å®šã—ã¾ã™ã€‚
```py
from transformers import pipeline
generator = pipeline(task='text-generation')
```

2. æ–‡ç« ã‚’pipeline()ã«å…¥åŠ›ã—ã¾ã™ã€‚
```py
generator(
    "Three Rings for the Elven-kings under the sky, Seven for the Dwarf-lords in their halls of stone"
)
```
ãƒ»å‡ºåŠ›
[{'generated_text': 'Three Rings for the Elven-kings under the sky, Seven for the Dwarf-lords in their halls of stone, Eight for the Dwarven-lords, Nine for the Elves and Orcs of the world, and more. With great dedication the'}]

å‡ºåŠ›ã‚’è¦‹ã‚‹ã¨ã€å…¥åŠ›ã—ãŸæ–‡ç« ã«ç¶šãæ–‡ç« ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚ã™ã”ã„ã§ã™ã­ï½

2ã¤ä»¥ä¸Šã®å…¥åŠ›ãŒã‚ã‚‹æ™‚ã¯ã€ãƒªã‚¹ãƒˆã¨ã—ã¦å…¥åŠ›ã—ã¾ã™ã€‚
```py
generator(
    [
        "Three Rings for the Elven-kings under the sky, Seven for the Dwarf-lords in their halls of stone",
        "Nine for Mortal Men, doomed to die, One for the Dark Lord on his dark throne",
    ]
)
```
ãƒ»å‡ºåŠ›
[[{'generated_text': 'Three Rings for the Elven-kings under the sky, Seven for the Dwarf-lords in their halls of stone, Eight for the Orc-lords in their castles.\n\nEach of these books is designed to be an effective one, which was'}],
 [{'generated_text': "Nine for Mortal Men, doomed to die, One for the Dark Lord on his dark throne.\n\nGwen's life\n\nGwen met the Master for the first time when she and her brother Arthur returned to their mortal home in the distant"}]]

ã‚¿ã‚¹ã‚¯ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã€pipeline()ã«å«ã‚ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã‚¿ã‚¹ã‚¯ã«ã¯ã€å‡ºåŠ›ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã®ã„ãã¤ã‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤generate()ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€è¤‡æ•°ã®å‡ºåŠ›ã‚’ç”Ÿæˆã—ãŸã„å ´åˆã¯ã€num_return_sequencesãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã™ã€‚
```py
generator(
    "Three Rings for the Elven-kings under the sky, Seven for the Dwarf-lords in their halls of stone",
    num_return_sequences=2,
)
```
ãƒ»å‡ºåŠ›
[{'generated_text': 'Three Rings for the Elven-kings under the sky, Seven for the Dwarf-lords in their halls of stone!\n\nLions and Elves\n\nLions of Night\n\nLions of Night Elves\n\nLions of Night\n'},
 {'generated_text': 'Three Rings for the Elven-kings under the sky, Seven for the Dwarf-lords in their halls of stone, or One Ring for those who are in trouble in their castle? No matter how many Rings were left out of the main-event'}]

### ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’é¸ã¶
pipeline()ã¯Model Hubã‹ã‚‰ä»»æ„ã®ãƒ¢ãƒ‡ãƒ«ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚Model Hubã«ã¯ã‚¿ã‚°ãŒã‚ã‚Šã€ã‚¿ã‚¹ã‚¯ã«ä½¿ã„ãŸã„ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚é©åˆ‡ãªãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ãŸã‚‰ã€å¯¾å¿œã™ã‚‹AutoModelForï½ã¨AutoTokenizerã‚¯ãƒ©ã‚¹ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€å› æœé–¢ä¿‚è¨€èªãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã®ãŸã‚ã«ã€AutoModelForCausalLMã‚¯ãƒ©ã‚¹ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
```py
from transformers import AutoTokenizer, AutoModelForCausalLM

tokenizer = AutoTokenizer.from_pretrained("distilgpt2")
model = AutoModelForCausalLM.from_pretrained("distilgpt2")
```

pipeline()ã‚’ä½œæˆã—ã€å…ˆã»ã©ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’æŒ‡å®šã—ã¾ã™ã€‚
```py
from transformers import pipeline

generator = pipeline(task="text-generation", model=model, tokenizer=tokenizer)
```

ãƒ†ã‚­ã‚¹ãƒˆã‚’pipeline()ã«å…¥åŠ›ã—ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```py
generator(
    "Three Rings for the Elven-kings under the sky, Seven for the Dwarf-lords in their halls of stone"
)
```
ãƒ»å‡ºåŠ›
[{'generated_text': 'Three Rings for the Elven-kings under the sky, Seven for the Dwarf-lords in their halls of stone and the Iron-blood kings in their halls of stone. Five-year ago they would be out on a journey, and now they'}]

## Audio pipeline
pipeline()ã¯éŸ³å£°ã‚¿ã‚¹ã‚¯ã«ã‚‚å¯¾å¿œã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€æ¬¡ã®éŸ³å£°ã®æ„Ÿæƒ…ã‚’åˆ†é¡ã—ã¾ã™ã€‚
```py
from datasets import load_dataset
import torch

torch.manual_seed(42)
ds = load_dataset("hf-internal-testing/librispeech_asr_demo", "clean", split="validation")
audio_file = ds[0]["audio"]["path"]
```

Model Hubã§æ„Ÿæƒ…åˆ†æç”¨ã®éŸ³å£°åˆ†é¡ãƒ¢ãƒ‡ãƒ«ã‚’è¦‹ã¤ã‘ã¦ã€pipeline()ã«ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
```py
from transformers import pipeline

audio_classifier = pipeline(
    task="audio-classification", model="ehcalabres/wav2vec2-lg-xlsr-en-speech-emotion-recognition"
)
```

æœ€å¾Œã«éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’pipeline()ã«å…¥åŠ›ã—ã¾ã™ã€‚
```py
preds = audio_classifier(audio_file)
preds = [{"score": round(pred["score"], 4), "label": pred["label"]} for pred in preds]
preds
```
ãƒ»å‡ºåŠ›
[{'score': 0.1315, 'label': 'calm'},
 {'score': 0.1307, 'label': 'neutral'},
 {'score': 0.1274, 'label': 'sad'},
 {'score': 0.1261, 'label': 'fearful'},
 {'score': 0.1242, 'label': 'happy'}]

## Vision pipeline
æ¬¡ã¯ç”»åƒã‚¿ã‚¹ã‚¯ã§ã™ã€‚ã¾ãšã€ç”»åƒã®ã‚¿ã‚¹ã‚¯ã‚’æŒ‡å®šã—ã€åˆ†é¡å™¨ã«ç”»åƒã‚’å…¥åŠ›ã—ã¾ã™ã€‚ã“ã®éš›ã€ç”»åƒã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«urlã§æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ä»Šå›ç”¨ã„ãŸç”»åƒï¼šhttps://huggingface.co/datasets/huggingface/documentation-images/resolve/main/pipeline-cat-chonk.jpeg

![](https://storage.googleapis.com/zenn-user-upload/1a26ede7f9b9-20220913.jpeg)

```py
from transformers import pipeline

vision_classifier = pipeline(task="image-classification")
preds = vision_classifier(
    images="https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/pipeline-cat-chonk.jpeg"
)
preds = [{"score": round(pred["score"], 4), "label": pred["label"]} for pred in preds]
preds
```
ãƒ»å‡ºåŠ›
[{'score': 0.4403, 'label': 'lynx, catamount'},
 {'score': 0.0343,
  'label': 'cougar, puma, catamount, mountain lion, painter, panther, Felis concolor'},
 {'score': 0.0321, 'label': 'snow leopard, ounce, Panthera uncia'},
 {'score': 0.0235, 'label': 'Egyptian cat'},
 {'score': 0.023, 'label': 'tiger cat'}]

# ãŠã‚ã‚Šã«
æœ€å¾Œã¾ã§èª­ã‚“ã§é ‚ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã€éŸ³å£°åˆ†é¡ã€ç”»åƒåˆ†é¡ã¨ã„ã£ãŸæ§˜ã€…ãªã‚¿ã‚¹ã‚¯ã«å¯¾å¿œã§ãã‚‹transformersã¯ã™ã”ã„ã§ã™ã­ï¼